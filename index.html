<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Relate — Local Prototype</title>
<style>
:root{
  --bg:#120018; --card:#1f0630; --accent:#9b6bff; --muted:#cdb8ff; --white:#ffffff;
  --blue:#70c6ff; --green:#6ee07a; --yellow:#ffd24d; --pink:#ff90d0; --red:#ff6b6b; --whiteRel:#ffffff;
}
html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--white)}
.app{display:flex;height:100vh;gap:18px;padding:18px;box-sizing:border-box}
.sidebar{width:320px;background:linear-gradient(180deg,#22002d,#1a0023);padding:16px;border-radius:12px;overflow:auto}
.main{flex:1;display:flex;flex-direction:column}
h1{color:var(--accent);margin:2px 0 10px 0}
label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
input,select,textarea,button{font-family:inherit}
input[type="text"], input[type="password"], select, textarea{width:100%;padding:10px;border-radius:8px;border:none;margin-top:6px;background:#fff;color:#111;box-sizing:border-box}
button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.small{font-size:12px;color:var(--muted)}
.usersList{margin-top:12px;max-height:42vh;overflow:auto}
.userRow{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.03)}
.card{background:linear-gradient(180deg,#170022,#0f0018);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:12px;height:100%}
.tabRow{display:flex;gap:8px}
.tabRow button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px}
.active{background:var(--accent);color:#fff;border:none}
.mapArea{flex:1;border-radius:8px;overflow:hidden;position:relative;background:radial-gradient(circle at 20% 10%, rgba(155,107,255,0.05), transparent 5%), #0b0012}
svg{width:100%;height:100%}
.tooltip{position:absolute;pointer-events:none;background:linear-gradient(180deg,#3b0064,#6200b0);padding:8px;border-radius:8px;color:#fff;font-size:13px;transform:translate(-50%,-120%);white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,0.6)}
.overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6);z-index:50}
.requestsBox{background:#fff;color:#111;padding:10px;border-radius:8px;max-height:240px;overflow:auto}
.requestItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f6f3ff;margin-bottom:8px}
.friendItem{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;margin-bottom:6px}
.quick{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.quick button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:6px;color:var(--muted)}
.exportArea{margin-top:12px}
.smallMuted{font-size:12px;color:var(--muted)}
.badge{background:rgba(155,107,255,0.18);padding:6px 10px;border-radius:999px;color:var(--muted);font-weight:600}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h1>Relate</h1>

    <div id="loginPanel">
      <label>Name</label>
      <input id="nameInput" placeholder="Your name">
      <label>Password</label>
      <input id="passInput" type="password" placeholder="Pick a password">
      <label>Class</label>
      <select id="classSelect"><option value="">Select class</option></select>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="enterBtn">Enter</button>
        <button id="logoutBtn" style="display:none;background:#444">Logout</button>
      </div>
      <div style="margin-top:8px" class="smallMuted">Logged in as: <span id="logged">—</span></div>
    </div>

    <hr style="border:none;height:1px;background:rgba(255,255,255,0.04);margin:12px 0">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small">People</div>
      <div><span class="badge" id="reqBadge">0</span></div>
    </div>

    <div class="usersList" id="usersList"></div>

    <hr style="border:none;height:1px;background:rgba(255,255,255,0.04);margin:12px 0">

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center"><div class="small">You Might Know</div><div class="smallMuted">auto</div></div>
      <div id="suggestions" style="margin-top:8px"></div>
    </div>

    <div class="exportArea">
      <div class="small" style="margin-top:12px">Export / Import state (copy-paste to test multi-browser)</div>
      <textarea id="stateArea" rows="5" style="width:100%;margin-top:6px"></textarea>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="exportBtn">Copy state</button>
        <button id="importBtn" style="background:#444">Paste state</button>
        <button id="refreshBtn" style="background:#333">Refresh</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;flex-direction:column">
          <div style="display:flex;gap:8px" id="tabs">
            <button data-tab="requests">Requests</button>
            <button data-tab="messages">Messages</button>
            <button data-tab="map" class="active">Map</button>
            <button data-tab="search">Search</button>
            <button data-tab="connections">Connections</button>
          </div>
          <div class="small" id="subInfo">Hover nodes for info — click to open profile</div>
        </div>
        <div><button id="btnRefresh">Refresh</button></div>
      </div>

      <!-- content areas -->
      <div id="contentRequests" style="display:none">
        <div class="requestsBox" id="requestsBox"></div>
      </div>

      <div id="contentMessages" style="display:none">
        <div><strong>Quick messages</strong></div>
        <div class="quick" id="quickPhrases"></div>
        <div style="margin-top:12px"><strong>Active chats</strong></div>
        <div id="chatsList"></div>
      </div>

      <div id="contentMap" style="display:block" class="mapArea">
        <svg id="mapSvg" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet"></svg>
        <div id="tooltip" class="tooltip" style="display:none"></div>
        <div id="overlay" class="overlay" style="display:none"></div>
      </div>

      <div id="contentSearch" style="display:none">
        <div style="display:flex;gap:8px">
          <input id="searchInput" placeholder="Search user...">
          <button id="searchBtn">Search</button>
        </div>
        <div id="searchResult" style="margin-top:12px"></div>
      </div>

      <div id="contentConnections" style="display:none">
        <div><strong>Your Connections</strong></div>
        <div id="connectionsList" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* Local Relate v1 — Single-file local prototype */

// localStorage key
const KEY = 'local_relate_state_v1';

// populate class dropdown 1..12
const classSelect = document.getElementById('classSelect');
for(let i=1;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent=`Class ${i}`; classSelect.appendChild(o); }

// quick phrases
const canned = ['hi','bye','brb','ttyl','wsp','good','wow','ok','gtg'];
const quickPhrasesDiv = document.getElementById('quickPhrases');
canned.forEach(p=>{ const b=document.createElement('button'); b.textContent=p; b.onclick=()=> quickSend(p); quickPhrasesDiv.appendChild(b); });

// state model
/* state = {
  users: [{name,passwordHash,class}],
  requests: [{id, from, to, time}],          // pending only
  connections: [{id, userA, userB, typeA, typeB, lastChangedA, lastChangedB}], // relation picks, null if not set
  messages: [{chatId, from, to, text, time}],
  notifications: [{to, text, time, seen}],
  suggestionsDismissed: [ {by:'username', suggestedName } ] // optional
}
*/
function defaultState(){ return { users:[], requests:[], connections:[], messages:[], notifications:[], suggestionsDismissed:[] }; }
function loadState(){ try{ const raw = localStorage.getItem(KEY); return raw? JSON.parse(raw): defaultState(); }catch(e){ console.error('load error',e); return defaultState(); }}
function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
let state = loadState();

// simple SHA-256 for password hashing (browser native)
async function sha256(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// current user
let currentUser = JSON.parse(localStorage.getItem('local_relate_current')) || null;

// DOM refs
const nameInput = document.getElementById('nameInput');
const passInput = document.getElementById('passInput');
const enterBtn = document.getElementById('enterBtn');
const logoutBtn = document.getElementById('logoutBtn');
const logged = document.getElementById('logged');
const usersList = document.getElementById('usersList');
const suggestionsDiv = document.getElementById('suggestions');
const reqBadge = document.getElementById('reqBadge');
const mapSvg = document.getElementById('mapSvg');
const tooltip = document.getElementById('tooltip');
const overlay = document.getElementById('overlay');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const refreshBtn = document.getElementById('refreshBtn');
const stateArea = document.getElementById('stateArea');
const btnRefresh = document.getElementById('btnRefresh');

// tabs
document.querySelectorAll('#tabs button').forEach(b=> b.addEventListener('click', ()=> selectTab(b.dataset.tab)));
function selectTab(tab){
  ['requests','messages','map','search','connections'].forEach(t=>{
    document.getElementById('content'+capitalize(t)).style.display = t===tab? (t==='map'? 'block':'block') : 'none';
    const btn = [...document.querySelectorAll('#tabs button')].find(x=>x.dataset.tab===t);
    if(btn) btn.classList.toggle('active', t===tab);
  });
}

// helpers
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function uid(){ return 'id_' + Math.random().toString(36).slice(2,10); }
function findUser(name){ return state.users.find(u=>u.name.toLowerCase()===name.toLowerCase()); }
function connectionId(a,b){ return [a.trim().toLowerCase(), b.trim().toLowerCase()].sort().join('__'); }
function now(){ return Date.now(); }

// render core UI
async function renderAll(){
  saveState(state);
  renderUsersList();
  renderSuggestions();
  renderRequests();
  renderConnectionsList();
  updateReqBadge();
  drawMap();
  renderChatsList();
}

function updateReqBadge(){
  if(!currentUser){ reqBadge.textContent='0'; return; }
  const c = state.requests.filter(r=> r.to.toLowerCase()===currentUser.name.toLowerCase()).length;
  reqBadge.textContent = String(c);
}

// login flow
enterBtn.addEventListener('click', async ()=>{
  const name = nameInput.value.trim();
  const pass = passInput.value;
  const klass = classSelect.value;
  if(!name || !pass || !klass) return alert('Enter name, password and class');
  const h = await sha256(pass);
  const existing = findUser(name);
  if(existing){
    if(existing.passHash && existing.passHash !== h) return alert('Wrong password for this username.');
    // login
    currentUser = { name: existing.name, class: existing.class || klass };
    if(existing.class !== klass){ existing.class = klass; }
    saveState(state);
    localStorage.setItem('local_relate_current', JSON.stringify(currentUser));
    postLogin();
    return;
  } else {
    // create user
    state.users.push({ name, passHash: h, class: klass });
    saveState(state);
    currentUser = { name, class: klass };
    localStorage.setItem('local_relate_current', JSON.stringify(currentUser));
    postLogin();
    return;
  }
});

logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem('local_relate_current');
  currentUser = null;
  document.getElementById('loginPanel').style.display = 'block';
  renderAll();
});

function postLogin(){
  document.getElementById('loginPanel').style.display = 'none';
  logoutBtn.style.display = 'inline-block';
  logged.textContent = `${currentUser.name} (Class ${currentUser.class})`;
  renderAll();
}

// initial show/hide
(function init(){
  if(currentUser){
    document.getElementById('loginPanel').style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    logged.textContent = `${currentUser.name} (Class ${currentUser.class})`;
  }
  renderAll();
})();

// rendering users sidebar
function renderUsersList(){
  usersList.innerHTML = '';
  const others = state.users.filter(u => !currentUser || u.name.toLowerCase() !== currentUser.name.toLowerCase());
  others.sort((a,b)=>a.name.localeCompare(b.name));
  others.forEach(u=>{
    const r = document.createElement('div'); r.className='userRow';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${u.name}</div><div class="small">Class ${u.class||'–'}</div>`;
    const right = document.createElement('div');
    // check sent or connected
    const sent = state.requests.some(req => req.from.toLowerCase()=== (currentUser?currentUser.name.toLowerCase():'') && req.to.toLowerCase()===u.name.toLowerCase());
    const connected = state.connections.some(c => c.id === connectionId(u.name, currentUser?currentUser.name:''));
    const btn = document.createElement('button');
    if(connected){ btn.textContent='Connected'; btn.disabled=true; }
    else if(sent){ btn.textContent='Sent ✓'; btn.disabled=true; }
    else { btn.textContent='+'; btn.disabled = !currentUser; }
    btn.onclick = ()=>{
      if(!currentUser) return alert('Login first.');
      // add request
      state.requests.push({ id: uid(), from: currentUser.name, to: u.name, time: now() });
      saveState(state);
      renderAll();
      alert(`✅ Request sent to ${u.name}`);
    };
    right.appendChild(btn);
    r.appendChild(left); r.appendChild(right);
    usersList.appendChild(r);
  });
}

// suggestions: users with >=3 mutuals
function renderSuggestions(){
  suggestionsDiv.innerHTML = '';
  if(!currentUser) { suggestionsDiv.innerHTML = '<div class="smallMuted">Login to see suggestions</div>'; return; }
  const myConns = state.connections.filter(c => c.userA.toLowerCase()===currentUser.name.toLowerCase() || c.userB.toLowerCase()===currentUser.name.toLowerCase()).map(c => (c.userA.toLowerCase()===currentUser.name.toLowerCase()? c.userB : c.userA));
  const arr = [];
  state.users.forEach(u=>{
    if(u.name.toLowerCase()===currentUser.name.toLowerCase()) return;
    if(myConns.includes(u.name)) return;
    let mutual=0;
    myConns.forEach(m=>{
      // check if m connected to u
      if(state.connections.some(cc => (cc.userA.toLowerCase()===m.toLowerCase() && cc.userB.toLowerCase()===u.name.toLowerCase()) || (cc.userB.toLowerCase()===m.toLowerCase() && cc.userA.toLowerCase()===u.name.toLowerCase()))) mutual++;
    });
    if(mutual >= 3){
      // check dismissed
      const dismissed = state.suggestionsDismissed.some(d => d.by && d.by.toLowerCase()===currentUser.name.toLowerCase() && d.suggested.toLowerCase()===u.name.toLowerCase());
      if(!dismissed) arr.push({ user:u, mutual });
    }
  });
  if(arr.length===0){ suggestionsDiv.innerHTML = '<div class="smallMuted">No suggestions for now.</div>'; return; }
  arr.forEach(s=>{
    const d = document.createElement('div'); d.className='userRow';
    d.innerHTML = `<div><div style="font-weight:700">${s.user.name}</div><div class="small">Class ${s.user.class||'–'} • ${s.mutual} mutuals</div></div>`;
    const right = document.createElement('div');
    const add = document.createElement('button'); add.textContent='+';
    add.onclick = ()=>{ state.requests.push({ id: uid(), from: currentUser.name, to: s.user.name, time: now() }); saveState(state); renderAll(); alert('Request sent'); };
    const x = document.createElement('button'); x.textContent='×'; x.style.marginLeft='6px';
    x.onclick = ()=>{ state.suggestionsDismissed.push({ by: currentUser.name, suggested: s.user.name }); saveState(state); renderSuggestions(); };
    right.appendChild(add); right.appendChild(x);
    d.appendChild(right);
    suggestionsDiv.appendChild(d);
  });
}

// requests UI
function renderRequests(){
  const box = document.getElementById('requestsBox');
  box.innerHTML = '<strong>Incoming requests</strong>';
  if(!currentUser) { box.innerHTML += '<div class="smallMuted">Login to see requests</div>'; return; }
  const inc = state.requests.filter(r => r.to.toLowerCase()===currentUser.name.toLowerCase());
  if(inc.length===0) box.innerHTML += '<div class="smallMuted">No pending requests</div>';
  inc.forEach(r=>{
    const div = document.createElement('div'); div.className='requestItem';
    div.innerHTML = `<div><div style="font-weight:700">${r.from}</div><div class="small">${new Date(r.time).toLocaleString()}</div></div>`;
    const right = document.createElement('div');
    const acc = document.createElement('button'); acc.textContent='Accept';
    acc.onclick = ()=>{
      // create connection doc if not exists
      const id = connectionId(r.from, r.to);
      if(!state.connections.some(c=>c.id===id)){
        state.connections.push({ id, userA: r.from, userB: r.to, typeA: null, typeB: null, lastChangedA:null, lastChangedB:null });
      }
      // remove request
      state.requests = state.requests.filter(x => x.id !== r.id);
      // notify requester
      state.notifications.push({ to: r.from, text: `${r.to} accepted your connection.`, time: now(), seen:false });
      saveState(state);
      renderAll();
      alert('Connection accepted');
    };
    const dec = document.createElement('button'); dec.textContent='Decline'; dec.style.marginLeft='6px';
    dec.onclick = ()=>{
      state.requests = state.requests.filter(x => x.id !== r.id);
      saveState(state);
      renderAll();
    };
    right.appendChild(acc); right.appendChild(dec);
    div.appendChild(right);
    box.appendChild(div);
  });
}

// connections list
function renderConnectionsList(){
  const area = document.getElementById('connectionsList');
  area.innerHTML = '';
  if(!currentUser) { area.innerHTML = '<div class="smallMuted">Login to see connections</div>'; return; }
  const my = state.connections.filter(c => c.userA.toLowerCase()===currentUser.name.toLowerCase() || c.userB.toLowerCase()===currentUser.name.toLowerCase());
  if(my.length===0){ area.innerHTML = '<div class="smallMuted">No connections yet</div>'; return; }
  my.forEach(c=>{
    const other = c.userA.toLowerCase() === currentUser.name.toLowerCase() ? c.userB : c.userA;
    const div = document.createElement('div'); div.className='friendItem';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div>${other}</div><div><button onclick="openProfileClient('${other.replace(/'/g,"\\'")}')">Profile</button></div></div>`;
    area.appendChild(div);
  });
}

// chats list for messages tab
function renderChatsList(){
  const container = document.getElementById('chatsList');
  container.innerHTML = '';
  if(!currentUser) { container.innerHTML = '<div class="smallMuted">Login to chat, login first.</div>'; return; }
  const my = state.connections.filter(c => c.userA.toLowerCase()===currentUser.name.toLowerCase() || c.userB.toLowerCase()===currentUser.name.toLowerCase());
  my.forEach(c=>{
    const other = c.userA.toLowerCase() === currentUser.name.toLowerCase() ? c.userB : c.userA;
    const chatId = connectionId(currentUser.name, other);
    const latest = state.messages.filter(m=>m.chatId===chatId).sort((a,b)=>b.time-a.time)[0];
    const div = document.createElement('div'); div.className='friendItem';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${other}</strong><div class="small">${latest? (latest.from + ': ' + latest.text): 'No messages'}</div></div><div><button onclick="openChatClient('${other.replace(/'/g,"\\'")}')">Open</button></div></div>`;
    container.appendChild(div);
  });
  if(my.length===0) container.innerHTML = '<div class="smallMuted">No connections to message.</div>';
}

// open chat from global
window.openChatClient = function(name){ openChat(name); };

// chat functionality
function openChat(name){
  overlay.style.display='block';
  overlay.innerHTML='';
  const title = document.createElement('div'); title.innerHTML = `<h3 style="margin:0">Chat with ${name}</h3>`; overlay.appendChild(title);
  const messagesDiv = document.createElement('div'); messagesDiv.style.maxHeight='200px'; messagesDiv.style.overflow='auto'; messagesDiv.style.background='#fff'; messagesDiv.style.color='#111'; messagesDiv.style.padding='8px'; messagesDiv.style.borderRadius='8px'; messagesDiv.style.marginTop='8px';
  overlay.appendChild(messagesDiv);
  const input = document.createElement('input'); input.placeholder='Type a message'; input.style.marginTop='8px';
  const send = document.createElement('button'); send.textContent='Send'; send.style.marginLeft='6px';
  send.onclick = ()=>{
    const txt = input.value.trim(); if(!txt) return;
    const chatId = connectionId(currentUser.name, name);
    state.messages.push({ chatId, from: currentUser.name, to: name, text: txt, time: now() });
    saveState(state); input.value=''; renderMessages(messagesDiv, chatId);
  };
  overlay.appendChild(input); overlay.appendChild(send);
  const close = document.createElement('button'); close.textContent='Close'; close.style.marginTop='10px'; close.style.marginLeft='8px';
  close.onclick = ()=> overlay.style.display='none';
  overlay.appendChild(close);
  renderMessages(messagesDiv, connectionId(currentUser.name, name));
}

function renderMessages(container, chatId){
  container.innerHTML = '';
  const msgs = state.messages.filter(m=>m.chatId===chatId).sort((a,b)=>a.time-b.time);
  msgs.forEach(m=>{
    const d = document.createElement('div'); d.style.margin='6px 0'; d.style.padding='6px'; d.style.borderRadius='6px'; d.style.background = m.from===currentUser.name? '#dfeaff':'#ffeef2'; d.textContent = `${m.from}: ${m.text}`;
    container.appendChild(d);
  });
}

// quick phrase send while chat opened
function quickSend(phrase){
  const h3 = overlay.querySelector('h3');
  if(!h3) return alert('Open a chat first (click a connection -> Chat).');
  const name = h3.textContent.replace('Chat with ','').trim();
  const chatId = connectionId(currentUser.name, name);
  state.messages.push({ chatId, from: currentUser.name, to: name, text: phrase, time: now() });
  saveState(state);
  renderMessages(overlay.querySelector('div[style*="maxHeight"]'), chatId);
  renderChatsList();
}

// map rendering
function drawMap(){
  mapSvg.innerHTML = ''; tooltip.style.display='none'; overlay.style.display='none';
  if(!currentUser) return;
  const centerX = 500, centerY = 350;
  const center = { name: currentUser.name, x:centerX, y:centerY, r:30, isCenter:true };
  // direct connections
  const direct = state.connections.filter(c => c.userA.toLowerCase()===currentUser.name.toLowerCase() || c.userB.toLowerCase()===currentUser.name.toLowerCase());
  const friendNames = Array.from(new Set(direct.map(c => c.userA.toLowerCase()===currentUser.name.toLowerCase()? c.userB : c.userA)));
  const nodes = [center];
  const count = friendNames.length;
  const radius = Math.min(300, 90 + count*28);
  friendNames.forEach((nm,i)=>{
    const angle = (i / Math.max(1,count)) * Math.PI * 2 - Math.PI/2;
    const x = centerX + radius * Math.cos(angle);
    const y = centerY + radius * Math.sin(angle);
    nodes.push({ name: nm, x, y, r:20, isCenter:false });
  });
  function findNode(name){ return nodes.find(n => n.name.toLowerCase() === name.toLowerCase()); }

  // draw relationship lines among visible nodes if someone set relation
  state.connections.forEach(c=>{
    const nA = findNode(c.userA), nB = findNode(c.userB);
    if(!nA || !nB) return;
    const tA = c.typeA || null, tB = c.typeB || null;
    let draw=false, dashed=false, color=null;
    if(tA && tB){
      draw=true;
      if(tA === tB){ color = relationColor(tA); dashed=false; }
      else { color = '#9b9b9b'; dashed=false; } // mismatch
    } else if(tA || tB){
      draw=true; dashed=true; color = '#9b9b9b';
    } else { draw=false; }
    if(!draw) return;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', nA.x); line.setAttribute('y1', nA.y);
    line.setAttribute('x2', nB.x); line.setAttribute('y2', nB.y);
    line.setAttribute('stroke-width', 3);
    if(dashed){ line.setAttribute('stroke-dasharray','8 6'); line.setAttribute('stroke', color); }
    else line.setAttribute('stroke', color);
    mapSvg.appendChild(line);
  });

  // draw nodes
  nodes.forEach(node=>{
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('transform', `translate(${node.x},${node.y})`);
    g.setAttribute('data-name', node.name);
    const circ = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circ.setAttribute('r', node.r);
    circ.setAttribute('fill', node.isCenter ? '#cfa0ff' : '#70c6ff');
    circ.setAttribute('stroke','#fff'); circ.setAttribute('stroke-width', node.isCenter?2:1);
    circ.style.cursor = 'pointer';
    g.appendChild(circ);
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('y', node.isCenter?6:4); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size', node.isCenter?14:11); t.setAttribute('fill','#111'); t.textContent = node.name;
    g.appendChild(t);

    g.addEventListener('mouseenter', (ev)=> {
      tooltip.style.display='block';
      const user = findUser(node.name) || {};
      const myRel = getMyRelationTo(node.name);
      tooltip.innerHTML = `<strong>${node.name}</strong> • Class ${user.class||'–'}<br><span class="small">${myRel?('You set: '+myRel):'Relation not set'}</span>`;
      positionTooltip(ev);
    });
    g.addEventListener('mousemove', positionTooltip);
    g.addEventListener('mouseleave', ()=> tooltip.style.display='none');
    g.addEventListener('click', ()=> openProfile(node.name));
    mapSvg.appendChild(g);
  });

  function positionTooltip(ev){
    const rect = mapSvg.getBoundingClientRect();
    tooltip.style.left = (ev.clientX - rect.left) + 'px';
    tooltip.style.top = (ev.clientY - rect.top - 12) + 'px';
  }
}

function relationColor(type){
  if(!type) return '#9b9b9b';
  const t = type.toLowerCase();
  if(t.includes('friend') && t.includes('best')) return 'var(--yellow)';
  if(t.includes('best')) return 'var(--yellow)';
  if(t.includes('close')) return 'var(--green)';
  if(t.includes('friend')) return 'var(--blue)';
  if(t==='crush') return 'var(--pink)';
  if(t==='hate' || t==='enemy') return 'var(--red)';
  if(t==='classmate') return 'var(--whiteRel)';
  // fallback
  return '#9b9b9b';
}

// profile overlay
function openProfile(name){
  overlay.style.display='block'; overlay.innerHTML='';
  const user = findUser(name) || { class:'–' };
  const h = document.createElement('div'); h.innerHTML = `<h3 style="margin:0">${name}</h3>`; overlay.appendChild(h);
  const info = document.createElement('div'); info.className='smallMuted'; info.textContent = `Class ${user.class||'–'}`; overlay.appendChild(info);
  const cc = document.createElement('div'); cc.className='smallMuted'; cc.style.marginTop='8px'; cc.textContent = `Connections: ${connectionCount(name)}`; overlay.appendChild(cc);

  if(currentUser && currentUser.name.toLowerCase() !== name.toLowerCase()){
    // check connection exists
    const cid = connectionId(currentUser.name, name);
    const conn = state.connections.find(c => c.id === cid);
    if(conn){
      // relation selector
      const relWrap = document.createElement('div'); relWrap.style.marginTop='12px';
      relWrap.innerHTML = `<div style="margin-bottom:6px">Set your relation to this person (change once / 7 days)</div>`;
      const sel = document.createElement('select'); sel.className='relSelect';
      ['', 'Friends','Close Friends','Best Friends','Crush','Hate','Classmate'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent = v? v : 'Select relation'; sel.appendChild(o); });
      const existing = getMyRelationTo(name); if(existing) sel.value = existing;
      relWrap.appendChild(sel);
      const save = document.createElement('button'); save.textContent='Save relation'; save.style.marginTop='8px';
      save.onclick = ()=>{
        const chosen = sel.value;
        if(!chosen) return alert('Pick relation');
        // enforce 7-day cooldown
        const nowTs = now();
        if(conn){
          const isA = conn.userA.toLowerCase() === currentUser.name.toLowerCase();
          const last = isA ? conn.lastChangedA : conn.lastChangedB;
          if(last && (nowTs - last < 7*24*3600*1000)) return alert('You can change relation only once per 7 days.');
        }
        // set
        if(conn.userA.toLowerCase() === currentUser.name.toLowerCase()){ conn.typeA = chosen; conn.lastChangedA = now(); }
        else if(conn.userB.toLowerCase() === currentUser.name.toLowerCase()){ conn.typeB = chosen; conn.lastChangedB = now(); }
        else { /* shouldn't */ }
        // notify other user to pick (no reveal)
        const other = (conn.userA.toLowerCase()===currentUser.name.toLowerCase())? conn.userB : conn.userA;
        state.notifications.push({ to: other, text: `${currentUser.name} updated your connection status — pick your view.`, time: now(), seen:false });
        saveState(state);
        renderAll();
        alert('Relation saved. Other user will be notified.');
        overlay.style.display='none';
      };
      relWrap.appendChild(save);
      overlay.appendChild(relWrap);
    } else {
      const noConn = document.createElement('div'); noConn.className='smallMuted'; noConn.style.marginTop='12px'; noConn.textContent = 'You are not connected with this user.';
      overlay.appendChild(noConn);
    }
  }

  // chat if connected
  if(currentUser && areConnected(currentUser.name, name)){
    const chatTitle = document.createElement('div'); chatTitle.style.marginTop='12px'; chatTitle.innerHTML = `<strong>Chat with ${name}</strong>`;
    overlay.appendChild(chatTitle);
    const messagesDiv = document.createElement('div'); messagesDiv.style.maxHeight='160px'; messagesDiv.style.overflow='auto'; messagesDiv.style.background='#fff'; messagesDiv.style.color='#111'; messagesDiv.style.padding='8px'; messagesDiv.style.borderRadius='8px'; messagesDiv.style.marginTop='8px';
    overlay.appendChild(messagesDiv);
    const input = document.createElement('input'); input.placeholder='Type a message';
    const send = document.createElement('button'); send.textContent='Send'; send.style.marginLeft='6px';
    send.onclick = ()=>{ const txt = input.value.trim(); if(!txt) return; const chatId = connectionId(currentUser.name, name); state.messages.push({ chatId, from: currentUser.name, to: name, text: txt, time: now() }); saveState(state); input.value=''; renderMessages(messagesDiv, connectionId(currentUser.name, name)); renderChatsList(); };
    overlay.appendChild(input); overlay.appendChild(send);
    renderMessages(messagesDiv, connectionId(currentUser.name, name));
  }

  const close = document.createElement('button'); close.textContent='Close'; close.style.marginTop='12px'; close.style.marginLeft='8px'; close.onclick = ()=> overlay.style.display='none';
  overlay.appendChild(close);
}

function renderMessages(container, chatId){ container.innerHTML=''; const msgs = state.messages.filter(m=>m.chatId===chatId).sort((a,b)=>a.time-b.time); msgs.forEach(m=>{ const d = document.createElement('div'); d.style.margin='6px 0'; d.style.padding='6px'; d.style.borderRadius='6px'; d.style.background = m.from===currentUser.name? '#dfeaff':'#ffeef2'; d.textContent = `${m.from}: ${m.text}`; container.appendChild(d); }); }

// check if connected
function areConnected(a,b){ const id = connectionId(a,b); return state.connections.some(c=>c.id===id); }
function getMyRelationTo(other){
  if(!currentUser) return null;
  const id = connectionId(currentUser.name, other);
  const conn = state.connections.find(c=>c.id===id);
  if(!conn) return null;
  if(conn.userA.toLowerCase() === currentUser.name.toLowerCase()) return conn.typeA || null;
  if(conn.userB.toLowerCase() === currentUser.name.toLowerCase()) return conn.typeB || null;
  return null;
}
function connectionCount(name){
  return state.connections.filter(c => c.userA.toLowerCase()===name.toLowerCase() || c.userB.toLowerCase()===name.toLowerCase()).length;
}

// search
document.getElementById('searchBtn').addEventListener('click', ()=> {
  const q = document.getElementById('searchInput').value.trim();
  const out = document.getElementById('searchResult'); out.innerHTML='';
  if(!q) return out.textContent = 'Enter a name to search.';
  const found = findUser(q);
  if(!found) return out.textContent = 'User not found.';
  const div = document.createElement('div'); div.innerHTML = `<div style="font-weight:700">${found.name}</div><div class="small">Class ${found.class||'–'}</div>`;
  const btn = document.createElement('button');
  const sent = state.requests.some(r=> r.from.toLowerCase()=== (currentUser?currentUser.name.toLowerCase():'') && r.to.toLowerCase()===found.name.toLowerCase());
  const connected = state.connections.some(c=> c.id === connectionId(found.name, currentUser?currentUser.name:''));
  if(connected){ btn.textContent='Connected'; btn.disabled=true; } else if(sent){ btn.textContent='Sent ✓'; btn.disabled=true; } else { btn.textContent='Send Request'; }
  btn.onclick = ()=>{ state.requests.push({ id: uid(), from: currentUser.name, to: found.name, time: now() }); saveState(state); renderAll(); alert('Request sent'); };
  div.appendChild(btn); out.appendChild(div);
});

// export/import & refresh
exportBtn.addEventListener('click', ()=> { const t = JSON.stringify(state, null, 2); navigator.clipboard && navigator.clipboard.writeText(t); alert('State copied to clipboard.'); });
importBtn.addEventListener('click', ()=> { const txt = stateArea.value.trim(); if(!txt) return alert('Paste exported state JSON first.'); try{ const incoming = JSON.parse(txt); state = incoming; saveState(state); alert('Imported — click Refresh'); }catch(e){ alert('Bad JSON'); }});
refreshBtn.addEventListener('click', ()=> { state = loadState(); currentUser = JSON.parse(localStorage.getItem('local_relate_current')) || null; if(currentUser) { document.getElementById('loginPanel').style.display='none'; logoutBtn.style.display='inline-block'; logged.textContent = `${currentUser.name} (Class ${currentUser.class})`; } renderAll(); alert('Refreshed'); });
btnRefresh.addEventListener('click', ()=> { state = loadState(); renderAll(); alert('Refreshed'); });

// notifications (simple)
function renderNotifications(){ /* not showing UI for now, reqBadge covers main */ }

// utilities
function renderAllQuiet(){ saveState(state); renderUsersList(); renderSuggestions(); renderConnectionsList(); updateReqBadge(); drawMap(); renderChatsList(); }

// expose openProfile to inline buttons
window.openProfileClient = function(name){ openProfile(name); };

// helpers used by inline functions
window.openChatClient = openChat;

// initial render
renderAll();

</script>
</body>
</html>

  
