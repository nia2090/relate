<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Relate</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .screen { display: none; padding: 20px; }
    .active { display: block; }
    input, button {
      padding: 8px; margin: 6px; border-radius: 5px; border: none;
    }
    button { background: #ffcc00; cursor: pointer; }
    canvas { background: #222; margin-top: 20px; border: 1px solid #444; }
  </style>
</head>
<body>

  <div id="screen1" class="screen active">
    <h2>Enter Your Name</h2>
    <input id="usernameInput" placeholder="Your name">
    <button onclick="enterApp()">Enter</button>
  </div>

  <div id="screen2" class="screen">
    <h2>Welcome, <span id="displayName"></span>!</h2>
    <p>All users:</p>
    <ul id="userList"></ul>
    <p>Search for a friend:</p>
    <input id="searchInput" placeholder="Friend name">
    <button onclick="searchUser()">Search</button>
    <div id="searchResult"></div>
    <br>
    <button onclick="showMap()">View Relationship Map</button>
  </div>

  <div id="screen3" class="screen">
    <h2>Relationship Map</h2>
    <canvas id="map" width="600" height="400"></canvas><br>
    <button onclick="backToSearch()">Back</button>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDocs, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDWJGM1oL-3i1CS8RsOCmgoJLKMe0aRCMA",
      authDomain: "relate-8fed6.firebaseapp.com",
      projectId: "relate-8fed6",
      storageBucket: "relate-8fed6.firebasestorage.app",
      messagingSenderId: "189997542155",
      appId: "1:189997542155:web:5a16a249d6b1daf8cad00e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;

    async function enterApp() {
      const name = document.getElementById("usernameInput").value.trim();
      if (!name) return alert("Enter your name");
      currentUser = name;

      // add to firestore if not exists
      const ref = doc(db, "users", name);
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, { name, friends: [] });

      document.getElementById("displayName").textContent = name;
      showScreen(2);
      loadUsers();
    }

    async function loadUsers() {
      const snapshot = await getDocs(collection(db, "users"));
      const list = document.getElementById("userList");
      list.innerHTML = "";
      snapshot.forEach(docSnap => {
        const user = docSnap.data();
        if (user.name !== currentUser) {
          const li = document.createElement("li");
          li.textContent = user.name;
          list.appendChild(li);
        }
      });
    }

    async function searchUser() {
      const searchName = document.getElementById("searchInput").value.trim();
      const resultDiv = document.getElementById("searchResult");
      if (!searchName) return (resultDiv.textContent = "Enter a name.");

      const ref = doc(db, "users", searchName);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        resultDiv.textContent = "User not found.";
        return;
      }

      const relation = prompt(`Enter relationship type with ${searchName} (friend, enemy, crush, etc.):`);
      if (!relation) return;

      const curRef = doc(db, "users", currentUser);
      const curSnap = await getDoc(curRef);
      const curData = curSnap.data();

      curData.friends.push({ name: searchName, relation });
      await updateDoc(curRef, { friends: curData.friends });

      resultDiv.textContent = `${searchName} added as ${relation}.`;
    }

    function showMap() { showScreen(3); drawMap(); }
    function backToSearch() { showScreen(2); }

    function showScreen(num) {
      document.querySelectorAll(".screen").forEach((s, i) => {
        s.classList.toggle("active", i === num - 1);
      });
    }

    async function drawMap() {
      const canvas = document.getElementById("map");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const ref = doc(db, "users", currentUser);
      const snap = await getDoc(ref);
      const user = snap.data();
      if (!user || user.friends.length === 0) {
        ctx.fillStyle = "#fff";
        ctx.fillText("No friends to display yet!", 220, 200);
        return;
      }

      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      ctx.fillStyle = "#ffcc00";
      ctx.beginPath();
      ctx.arc(centerX, centerY, 30, 0, 2 * Math.PI);
      ctx.fill();
      ctx.fillStyle = "#000";
      ctx.fillText(currentUser, centerX - 15, centerY + 5);

      const count = user.friends.length;
      const radius = 120;
      const angleStep = (2 * Math.PI) / count;

      user.friends.forEach((f, i) => {
        const angle = i * angleStep;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);

        switch (f.relation.toLowerCase()) {
          case "friend": ctx.strokeStyle = "yellow"; break;
          case "enemy": ctx.strokeStyle = "red"; break;
          case "crush": ctx.strokeStyle = "pink"; break;
          default: ctx.strokeStyle = "lightblue";
        }
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(x, y);
        ctx.stroke();

        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, 2 * Math.PI);
        ctx.fill();

        ctx.fillStyle = "#000";
        ctx.fillText(f.name, x - 10, y + 5);
      });
    }
  </script>
</body>
</html>
